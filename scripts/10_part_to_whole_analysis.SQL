/*
===========================================
Part to Whole Analysis
Tables Used: invoice, 
             invoice_line, 
             track, genre, 
             media_type, 
             customer, 
             artist
===========================================
*/

-- Q1: What percentage of total revenue is contributed by each genre?
SELECT
	g.name AS genre,
	ROUND(SUM(il.unit_price * il.quantity), 2) AS total_revenue,
	ROUND(SUM(il.unit_price * il.quantity)/(SELECT SUM(total) FROM invoice) * 100, 2) 
	AS percentage_contribution
FROM
	genre g
JOIN
	track t ON g.genre_id = t.genre_id
JOIN
	invoice_line il ON t.track_id = il.track_id
GROUP BY 
	genre
ORDER BY
	percentage_contribution DESC;

-- Q2: What share of revenue comes from each media type?
SELECT
	m.name AS media_type,
	ROUND(SUM(il.unit_price * il.quantity), 2) AS total_revenue,
	ROUND(SUM(il.unit_price * il.quantity)/(SELECT SUM(total) FROM invoice) * 100, 2) 
	AS percentage_contribution
FROM
	media_type m
JOIN
	track t ON m.media_type_id = t.media_type_id
JOIN
	invoice_line il ON t.track_id = il.track_id
GROUP BY
	media_type
ORDER BY
	percentage_contribution DESC;

-- Q3: Revenue distribution by country
SELECT
	c.country,
	ROUND(SUM(i.total), 2) AS total_revenue,
	ROUND(SUM(i.total)/(SELECT SUM(total) FROM invoice) * 100 , 2)
	AS percentage_contribution
FROM
	customers c
JOIN
	invoice i ON c.customer_id = i.customer_id
GROUP BY
	c.country
ORDER BY
	percentage_contribution DESC;

-- Q4: What percentage of tracks belong to each genre?
SELECT
	g.name AS genre,
	COUNT(t.track_id) AS total_track_count,
	ROUND((COUNT(t.track_id) * 100)/(SELECT COUNT(*) FROM track), 2)
	AS percentage_contribution
FROM
	genre g
JOIN
	track t ON g.genre_id = t.genre_id
GROUP BY 
	genre
ORDER BY
	percentage_contribution DESC;

-- Q5: Which artists contribute the most to total sales revenue?
SELECT
	a.name AS artist_name,
	ROUND(SUM(il.unit_price * il.quantity), 2) AS total_revenue,
	ROUND(SUM(il.unit_price * il.quantity)/(SELECT SUM(total) FROM invoice) * 100, 2) 
	AS percentage_contribution
FROM
	artists a
JOIN
	albums ab ON a.artist_id = ab.artist_id
JOIN
	track t ON ab.album_id = t.album_id
JOIN
	invoice_line il ON t.track_id = il.track_id
GROUP BY
	artist_name
ORDER BY
	percentage_contribution DESC;

-- Q6: What percentage of track sales comes from the top 5 most sold tracks?

WITH                                                       -- total track sales 
track_sales AS(
SELECT
	t.track_id,
	SUM(il.quantity) AS total_sold
FROM
	track t
JOIN
	invoice_line il ON t.track_id = il.track_id
GROUP BY
	t.track_id
),
top_5 AS(                                                   -- top 5 track sales
SELECT
	SUM(total_sold) AS top_5_sales
FROM
	(SELECT 
		total_sold
	FROM 
		track_sales
	ORDER BY 
		total_sold DESC
	LIMIT 5) subquery
)
SELECT 
	ROUND(top_5_sales * 100/(SELECT SUM(quantity)FROM invoice_line), 2)                -- percentage contribution
	AS top_5_sales_percentage
FROM
	top_5;
	
-- Q7: What percentage of revenue is generated by top 10 customers?

WITH 
total_customer_revenue AS(
SELECT
	c.customer_id,
	SUM(i.total) AS total_revenue
FROM
	customers c
JOIN 
	invoice i ON c.customer_id = i.customer_id
GROUP BY
	c.customer_id
),
top_10 AS(
SELECT
	SUM(total_revenue) AS top_10_revenue
FROM
	(SELECT
		total_revenue 
	FROM
		total_customer_revenue
	ORDER BY
		total_revenue DESC
	LIMIT 10)
)
SELECT
	ROUND(top_10_revenue * 100/(SELECT SUM(total) FROM invoice), 2)
	AS total_percentage_revenue
FROM
	top_10;

-- Q8: Customer base distribution by country
SELECT
	country,
	COUNT(*) AS total_customers,
	COUNT(*) * 100/(SELECT COUNT(*) FROM customers) AS customer_distributon
FROM
	customers
GROUP BY 
	country
ORDER BY
	customer_distributon DESC;

-- Q9: What share of tracks sold belongs to each media type?
SELECT 
	m.name AS media_type,
	SUM(il.quantity) AS total_sales,
	ROUND(SUM(il.quantity) * 100/ (SELECT SUM(quantity) FROM invoice_line), 2)
	AS percentage_tracks
FROM
	media_type m
JOIN
	track t ON m.media_type_id = t.media_type_id
JOIN
	invoice_line il ON t.track_id = il.track_id
GROUP BY
	media_type
ORDER BY
	percentage_tracks DESC;

-- Q10: Distribution of invoices by billing country
SELECT
	billing_country,
	COUNT(invoice_id) AS total_invoices,
	ROUND(COUNT(invoice_id) * 100/(SELECT COUNT(*) FROM invoice), 2)
	AS invoice_distribution
FROM
	invoice
GROUP BY
	billing_country
ORDER BY
	invoice_distribution DESC;
